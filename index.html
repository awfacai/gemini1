<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheerID Verifier</title>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script>
        // 配置
        window.CONFIG = {
            workerUrl: "https://gemini.irvv.workers.dev",
            hcaptcha: { sitekey: "" },
            turnstile: { sitekey: "" },
            maxFileSize: 1 * 1024 * 1024
        };
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; margin: 0; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .input-section { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 13px; color: #666; margin-bottom: 6px; font-weight: 500; }
        .form-group input, .form-group select { padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .url-input { width: 100%; padding: 16px 20px; font-size: 15px; border: 2px solid #e0e0e0; border-radius: 12px; }
        .verify-button { margin-top: 15px; width: 100%; padding: 14px; background: #1a1a1a; color: #fff; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; max-width: 600px; width: 90%; text-align: center; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { font-size: 24px; border: none; background: none; cursor: pointer; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .modal-button { padding: 10px 24px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; }
        .modal-button-primary { background: #1a1a1a; color: #fff; }
        .modal-button-secondary { background: #f0f0f0; color: #666; }
        .console-section { background: #1a1a1a; color: #fff; border-radius: 12px; min-height: 200px; padding: 16px; font-family: monospace; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="input-section">
            <input type="text" id="urlInput" class="url-input" placeholder="粘贴 SheerID 验证链接...">
            <button class="verify-button" onclick="startVerification()">开始验证</button>
            <div class="form-grid" style="margin-top: 20px;">
                <div class="form-group"><label>名字 (First Name)</label><input type="text" id="firstName"></div>
                <div class="form-group"><label>姓氏 (Last Name)</label><input type="text" id="lastName"></div>
                <div class="form-group"><label>邮箱 (Email)</label><input type="email" id="email"></div>
                <div class="form-group"><label>生日 (Birth Date)</label><input type="date" id="birthDate"></div>
                <div class="form-group"><label>学号 (Student ID)</label><input type="text" id="studentId" value="INT731320"></div>
                <div class="form-group"><label>专业 (Faculty)</label><input type="text" id="faculty" value="Medicine"></div>
                <div class="form-group"><label>学校 (School)</label><select id="schoolId"><option value="nfe">Nfe Norddeutscher</option></select></div>
                <div class="form-group"><label>自定义Logo (可选)</label><input type="text" id="customLogoUrl"></div>
            </div>
        </div>
        <div class="console-section" id="consoleBody"></div>
    </div>

    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">学生证预览</span>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <p>请确认学生证信息是否正确</p>
                <canvas id="studentCard"></canvas>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" onclick="closeModal()">取消</button>
                <button class="modal-button modal-button-primary" onclick="confirmAndSubmit()">确认并提交</button>
            </div>
        </div>
    </div>

    <script>
        const schools = {
            'nfe': {
                name: 'Nfe Norddeutscher Fachverband\nElektro- Und Informationstechnik\nE.V. (Hamburg)',
                domain: 'nfe.edu',
                logo: 'assets/nfe.png'
            },
        };

        function log(message) {
            const consoleBody = document.getElementById('consoleBody');
            consoleBody.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            consoleBody.scrollTop = consoleBody.scrollHeight;
        }

        function getLogoUrl() {
            const customUrl = document.getElementById('customLogoUrl').value.trim();
            if (customUrl) return customUrl;
            return schools[document.getElementById('schoolId').value].logo;
        }
        
        async function generateCard(firstName, lastName, studentId, faculty, school) {
            log('正在生成学生证...');
            const canvas = document.getElementById('studentCard');
            const ctx = canvas.getContext('2d');
            canvas.width = 500;
            canvas.height = 310;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(10, 10, canvas.width - 20, canvas.height - 20, 12);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = '#dc2626';
            ctx.beginPath();
            ctx.roundRect(10, 10, canvas.width - 20, 75, [12, 12, 0, 0]);
            ctx.fill();

            const loadImage = (src) => new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                img.src = src;
            });

            try {
                const logo = await loadImage(getLogoUrl());
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.roundRect(30, 22, 50, 50, 8);
                ctx.fill();
                ctx.drawImage(logo, 35, 27, 40, 40);
                
                // --- 这是关键的修复 ---
                const avatar = await loadImage('assets/avatar.png'); 
                // --- 结束修复 ---

                ctx.beginPath();
                ctx.roundRect(30, 105, 90, 90, 8);
                ctx.clip();
                ctx.drawImage(avatar, 30, 105, 90, 90);
                ctx.resetTransform();

                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px "Segoe UI", Arial, sans-serif';
                ctx.textAlign = 'left';
                const schoolNameLines = school.name.split('\n');
                schoolNameLines.forEach((line, index) => ctx.fillText(line, 95, 38 + (index * 18)));
                ctx.font = '11px "Segoe UI", Arial, sans-serif';
                ctx.fillText('INTERNATIONAL STUDENT ID CARD', 95, 75);

                ctx.fillStyle = 'black';
                ctx.font = 'bold 20px "Segoe UI", Arial, sans-serif';
                ctx.fillText('NAME:', 140, 130);
                ctx.fillText('STUDENT ID:', 140, 160);
                ctx.fillText('FACULTY:', 140, 190);

                ctx.font = '20px "Segoe UI", Arial, sans-serif';
                ctx.fillText(`${firstName} ${lastName}`, 240, 130);
                ctx.fillText(studentId, 295, 160);
                ctx.fillText(faculty, 260, 190);

                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, 230);
                ctx.lineTo(canvas.width / 2, 280);
                ctx.stroke();

                ctx.fillStyle = '#6b7280';
                ctx.font = '14px "Segoe UI", Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ISSUE', canvas.width * 0.25 + 10, 250);
                ctx.fillText('VALID', canvas.width * 0.75 - 10, 250);

                ctx.fillStyle = 'black';
                ctx.font = 'bold 16px "Segoe UI", Arial, sans-serif';
                const issueDate = new Date();
                const validDate = new Date(issueDate);
                validDate.setFullYear(issueDate.getFullYear() + 4);
                const formatDate = (date) => date.toISOString().split('T')[0];
                ctx.fillText(formatDate(issueDate), canvas.width * 0.25 + 10, 275);
                ctx.fillText(formatDate(validDate), canvas.width * 0.75 - 10, 275);
                log('学生证生成成功。');
            } catch (error) {
                log(`错误: ${error.message}`);
            }
        }

        function showModal() { document.getElementById('previewModal').classList.add('show'); }
        function closeModal() { document.getElementById('previewModal').classList.remove('show'); }

        async function startVerification() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const studentId = document.getElementById('studentId').value;
            const faculty = document.getElementById('faculty').value;
            const school = schools[document.getElementById('schoolId').value];
            await generateCard(firstName, lastName, studentId, faculty, school);
            showModal();
        }

        function confirmAndSubmit() { 
            // This would contain the logic to submit the form data
            closeModal();
            log('已确认并提交 (功能待实现)');
        }

        window.onload = () => {
            // Set default values
            document.getElementById('firstName').value = "SODT";
            document.getElementById('lastName').value = "XIVWIO";
            document.getElementById('email').value = "test@nfe.edu";
            document.getElementById('birthDate').value = "2002-01-01";
            log('系统就绪。');
        };
    </script>
</body>
</html>
